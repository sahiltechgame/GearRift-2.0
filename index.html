<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GearRift 2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        :root {
            --primary-color: #00ffff;
            --danger-color: #ff4444;
            --dark-color: #0d0d0d;
            --road-color: #3a3a3a;
            --line-color: #cccccc;
            --grass-color: #004d00;
            --rumble-color-1: #ffffff;
            --rumble-color-2: #ff4444;
        }

        body {
            margin: 0;
            font-family: 'Orbitron', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: var(--dark-color);
            color: white;
            overflow: hidden;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #game-container {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            position: relative;
            overflow: hidden;
            background: linear-gradient(to top, #000, #1a2a3a);
        }

        canvas {
            display: none;
            background-color: transparent;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        #menu .bg-car-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: -1;
            opacity: 0.3;
            filter: blur(5px);
        }

        #menu .bg-car-container svg {
            width: 150%;
            max-width: 600px;
        }

        #menu h1 {
            font-size: 4.5rem;
            font-weight: 900;
            color: var(--primary-color);
            text-shadow: 0 0 15px var(--primary-color), 0 0 25px var(--primary-color), 0 0 50px white;
            margin: 0;
            letter-spacing: 3px;
        }
        
        #menu p {
            color: #ccc;
            margin-bottom: 60px;
            font-size: 1.2rem;
            text-shadow: 0 0 5px black;
        }

        .play-button {
            padding: 25px 50px;
            font-size: 30px;
            font-family: 'Orbitron', sans-serif;
            color: var(--dark-color);
            background: linear-gradient(45deg, var(--primary-color), #aaffff);
            border: 3px solid var(--primary-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 25px var(--primary-color), inset 0 0 15px rgba(255,255,255,0.7);
            font-weight: 900;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 25px var(--primary-color), inset 0 0 15px rgba(255,255,255,0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 40px var(--primary-color), 0 0 60px var(--primary-color), inset 0 0 20px rgba(255,255,255,0.9); }
            100% { transform: scale(1); box-shadow: 0 0 25px var(--primary-color), inset 0 0 15px rgba(255,255,255,0.7); }
        }

        .play-button:hover {
            transform: scale(1.15);
            animation-play-state: paused;
        }
        
        #game-ui, #hud, #controls-container {
            display: none;
            user-select: none;
        }

        #game-ui.active, #hud.active, #controls-container.active {
            display: flex;
        }
        
        #game-ui {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 22px;
            text-shadow: 0 0 5px black;
            z-index: 5;
            pointer-events: none;
        }
        
        #pause-btn {
            pointer-events: all;
            background: rgba(0,0,0,0.5);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
        }
        
        #hud {
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: column;
            gap: 5px;
            align-items: center;
            color: white;
            z-index: 5;
            pointer-events: none;
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 15px;
            border: 1px solid var(--primary-color);
            font-weight: 700;
        }
        
        #speedometer, #gear-display {
            font-size: 24px;
        }

        #controls-container {
            position: absolute;
            bottom: 20px;
            width: 100%;
            justify-content: space-around;
            align-items: flex-end;
            z-index: 20;
        }

        .pedal {
            width: 70px;
            height: 110px;
            border: 2px solid #888;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        #accelerator { background: linear-gradient(#444, #222); }
        #accelerator.pressed { background: linear-gradient(var(--primary-color), #00aaaa); box-shadow: 0 0 15px var(--primary-color); }
        
        #brake { background: linear-gradient(#444, #222); }
        #brake.pressed { background: linear-gradient(var(--danger-color), #aa2222); box-shadow: 0 0 15px var(--danger-color); }

        #gear-shifter { display: flex; flex-direction: column; gap: 10px; }
        
        .gear-btn {
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.7);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }

        #message-box {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 100;
            border: 2px solid var(--primary-color);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -40%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        
        #message-box h2 { margin-top: 0; color: var(--primary-color); }

        #message-box button {
            margin: 10px;
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--dark-color);
            border: none;
            cursor: pointer;
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <!-- Main Menu -->
        <div id="menu">
            <div class="bg-car-container">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 841.9 473.6">
                    <defs>
                        <linearGradient id="lgrad-1" x1="0%" y1="50%" x2="100%" y2="50%"><stop offset="0%" style="stop-color:#ff4444;stop-opacity:1" /><stop offset="100%" style="stop-color:#aa2222;stop-opacity:1" /></linearGradient>
                        <linearGradient id="lgrad-2" x1="0%" y1="50%" x2="100%" y2="50%"><stop offset="0%" style="stop-color:#00ffff;stop-opacity:1" /><stop offset="100%" style="stop-color:#00aaaa;stop-opacity:1" /></linearGradient>
                    </defs>
                    <path fill="url(#lgrad-1)" d="M129.5 240.6l-28.1-51.9L2.4 201.2l20.4-62.4 123.8-21.2 59.5-103.3 125.7 33.6 71.9 83.3 147.2 16.3 22.8 63.4-114.3 42.4-44.2 81.3-159.2 15.2-106-49.6z"/><path fill="#222" d="M101.4 188.7l59.5-103.3 125.7 33.6 71.9 83.3-257.1 1.9z"/><path fill="url(#lgrad-2)" d="M510.6 230l-22.8-63.4 147.2-16.3 71.9-83.3 83 23.9 22.8 54.3-51.9 20.2-83 74.3-167.2 8.3z"/><path fill="#222" d="M510.6 230l22.8-63.4-147.2-16.3-71.9 83.3zM657.8 150.3l71.9-83.3 83 23.9 22.8 54.3z"/>
                </svg>
            </div>
            <h1>GearRift 2.0</h1>
            <p>The Ultimate Arcade Racing Experience.</p>
            <button id="playBtn" class="play-button">PLAY</button>
        </div>

        <div id="game-ui"><div id="score">Score: 0</div><button id="pause-btn">||</button></div>
        <div id="hud"><div id="speedometer">0 KPH</div><div id="gear-display">N</div></div>
        <div id="controls-container"><div id="brake" class="pedal">BRAKE</div><div id="gear-shifter"><button id="gear-up" class="gear-btn">▲</button><button id="gear-down" class="gear-btn">▼</button></div><div id="accelerator" class="pedal">GAS</div></div>
        <div id="message-box"><h2 id="message-title">Paused</h2><p id="message-text"></p><button id="resume-btn">Resume</button><button id="restart-btn">Restart</button></div>
        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
    class Game {
        constructor() {
            // --- DOM BINDING ---
            this.elements = {
                menu: document.getElementById('menu'),
                playBtn: document.getElementById('playBtn'),
                canvas: document.getElementById('gameCanvas'),
                gameUI: document.getElementById('game-ui'),
                scoreEl: document.getElementById('score'),
                pauseBtn: document.getElementById('pause-btn'),
                hud: document.getElementById('hud'),
                speedometerEl: document.getElementById('speedometer'),
                gearDisplayEl: document.getElementById('gear-display'),
                controlsContainer: document.getElementById('controls-container'),
                accelerator: document.getElementById('accelerator'),
                brake: document.getElementById('brake'),
                gearUpBtn: document.getElementById('gear-up'),
                gearDownBtn: document.getElementById('gear-down'),
                messageBox: document.getElementById('message-box'),
                messageTitle: document.getElementById('message-title'),
                messageText: document.getElementById('message-text'),
                resumeBtn: document.getElementById('resume-btn'),
                restartBtn: document.getElementById('restart-btn'),
                container: document.getElementById('game-container')
            };
            this.ctx = this.elements.canvas.getContext('2d');

            // --- STYLING ---
            const styles = getComputedStyle(document.documentElement);
            this.colors = {
                road: styles.getPropertyValue('--road-color').trim(),
                line: styles.getPropertyValue('--line-color').trim(),
                grass: styles.getPropertyValue('--grass-color').trim(),
                rumble1: styles.getPropertyValue('--rumble-color-1').trim(),
                rumble2: styles.getPropertyValue('--rumble-color-2').trim()
            };

            // --- GAME STATE ---
            this.state = {};
            this.assets = {};
            
            // --- SOUND ---
            this.sounds = this.initSounds();

            this.init();
        }

        initSounds() {
            const engine = new Tone.Oscillator({
                type: 'sawtooth',
                frequency: 60,
                volume: -20
            }).toDestination();

            const crash = new Tone.NoiseSynth({
                noise: { type: 'white' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0 },
                volume: -5
            }).toDestination();
            
            engine.start();
            return { engine, crash };
        }
        
        // --- ASSET CREATION ---
        createAssets() {
            const createCar = (primary, secondary, accent, isPlayer = false) => {
                const svg = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 240">
                        <defs>
                            <linearGradient id="grad-${primary.replace('#','')}" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="${primary}"/><stop offset="100%" stop-color="${secondary}"/></linearGradient>
                            <filter id="glow"><feGaussianBlur stdDeviation="3.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                        </defs>
                        <path d="M30 10 C50 0, 70 0, 90 10 L115 80 C125 110, 125 130, 115 160 L90 230 C70 240, 50 240, 30 230 L5 160 C-5 130, -5 110, 5 80 Z" fill="url(#grad-${primary.replace('#','')})"/>
                        <path d="M30 10 C50 0, 70 0, 90 10 L115 80 C125 110, 125 130, 115 160 L90 230 C70 240, 50 240, 30 230 L5 160 C-5 130, -5 110, 5 80 Z" stroke="rgba(0,0,0,0.5)" stroke-width="2"/>
                        <path d="M15 110 L105 110 L100 50 C80 30, 40 30, 20 50 Z" fill="rgba(0,0,0,0.6)"/>
                        <path d="M18 105 L102 105 L98 55 C80 35, 42 35, 22 55 Z" fill="rgba(20,20,40,0.5)" />
                        <rect x="10" y="210" width="25" height="15" rx="5" fill="${accent}" class="taillight"/>
                        <rect x="85" y="210" width="25" height="15" rx="5" fill="${accent}" class="taillight"/>
                        ${isPlayer ? '<rect x="12" y="212" width="21" height="11" rx="3" fill="#ff8888" class="brakelight" visibility="hidden"/> <rect x="87" y="212" width="21" height="11" rx="3" fill="#ff8888" class="brakelight" visibility="hidden"/>' : ''}
                        <rect x="20" y="15" width="80" height="10" fill="rgba(255,255,255,0.2)"/>
                    </svg>`;
                const img = new Image();
                img.src = "data:image/svg+xml," + encodeURIComponent(svg);
                return img;
            };

            const createTruck = (color1, color2) => {
                const svg = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 280">
                      <rect x="5" y="5" width="110" height="270" rx="10" fill="${color1}"/>
                      <rect x="15" y="150" width="90" height="120" fill="${color2}"/>
                      <rect x="25" y="20" width="70" height="100" fill="rgba(0,0,0,0.4)"/>
                      <rect x="10" y="250" width="30" height="20" rx="5" fill="#ff4444"/>
                      <rect x="80" y="250" width="30" height="20" rx="5" fill="#ff4444"/>
                    </svg>`;
                const img = new Image();
                img.src = "data:image/svg+xml," + encodeURIComponent(svg);
                return img;
            };

            this.assets.playerImage = createCar('#ff4444', '#aa2222', '#cc0000', true);
            this.assets.obstacleImages = [
                createCar('#00aaff', '#0077cc', '#0055aa'),
                createCar('#cccccc', '#999999', '#777777'),
                createCar('#aaff00', '#77cc00', '#55aa00'),
                createTruck('#a52a2a', '#800000')
            ];
        }

        // --- EVENT BINDING ---
        bindEvents() {
            this.elements.playBtn.addEventListener('click', () => this.startGame());
            this.elements.pauseBtn.addEventListener('click', () => this.togglePause());
            this.elements.resumeBtn.addEventListener('click', () => this.togglePause());
            this.elements.restartBtn.addEventListener('click', () => {
                this.elements.messageBox.style.display = 'none';
                this.startGame();
            });

            // Keyboard
            document.addEventListener('keydown', e => this.handleKeyDown(e));
            document.addEventListener('keyup', e => this.handleKeyUp(e));

            // Touch
            const touchHandler = (el, pressCallback, releaseCallback) => {
                el.addEventListener('touchstart', e => { e.preventDefault(); pressCallback(e); }, { passive: false });
                el.addEventListener('touchend', e => { e.preventDefault(); releaseCallback(e); }, { passive: false });
            };
            touchHandler(this.elements.accelerator, () => { this.state.isAccelerating = true; this.elements.accelerator.classList.add('pressed'); }, () => { this.state.isAccelerating = false; this.elements.accelerator.classList.remove('pressed'); });
            touchHandler(this.elements.brake, () => { this.state.isBraking = true; this.elements.brake.classList.add('pressed'); }, () => { this.state.isBraking = false; this.elements.brake.classList.remove('pressed'); });
            this.elements.gearUpBtn.addEventListener('click', () => this.handleGearUp());
            this.elements.gearDownBtn.addEventListener('click', () => this.handleGearDown());
            
            let touchStartX = 0;
            this.elements.canvas.addEventListener('touchstart', e => {
                e.preventDefault();
                if (e.target === this.elements.canvas) touchStartX = e.touches[0].clientX;
            }, { passive: false });
            this.elements.canvas.addEventListener('touchmove', e => {
                e.preventDefault();
                 if (e.target === this.elements.canvas) {
                    const touchX = e.touches[0].clientX;
                    this.state.player.x += (touchX - touchStartX) * 1.5;
                    touchStartX = touchX;
                 }
            }, { passive: false });

            window.addEventListener('resize', () => this.resizeCanvas());
        }

        // --- GAME FLOW ---
        init() {
            this.createAssets();
            this.bindEvents();
            this.resizeCanvas();
        }

        startGame() {
            this.resetState();
            this.elements.menu.style.display = 'none';
            ['canvas', 'gameUI', 'hud', 'controlsContainer'].forEach(el => this.elements[el].style.display = 'block');
            ['gameUI', 'hud', 'controlsContainer'].forEach(el => this.elements[el].classList.add('active'));
            this.state.gameRunning = true;
            this.state.isPaused = false;
            if (Tone.context.state !== 'running') Tone.start();
            this.gameLoop();
        }

        resetState() {
            this.state = {
                gameRunning: false, isPaused: false, score: 0, carSpeed: 0, currentGear: 0,
                isAccelerating: false, isBraking: false,
                roadWidth: 0.9,
                player: { width: 60, height: 110, x: 0, y: 0, dx: 0, speed: 8 },
                obstacles: [], roadLines: [], scenery: [],
                rumbleCounter: 0,
                train: { active: false, y: 0, timer: 1000 + Math.random() * 2000, lightsOn: false },
                physics: { acceleration: 0.05, braking: 0.2, friction: 0.025, maxSpeed: 15, gearRatios: { '-1': 3, '0': 0, '1': 5, '2': 8, '3': 11, '4': 13, '5': 15 } }
            };
            this.state.player.x = this.elements.canvas.width / 2 - this.state.player.width / 2;
            this.state.player.y = this.elements.canvas.height - this.state.player.height - 30;
            for(let i=0; i<10; i++) this.state.roadLines.push({ y: i * (this.elements.canvas.height/10) });
        }

        gameOver() {
            this.state.gameRunning = false;
            this.sounds.crash.triggerAttackRelease("0.1s");
            this.sounds.engine.volume.rampTo(-Infinity, 0.2);
            cancelAnimationFrame(this.state.gameLoopId);
            this.elements.messageTitle.textContent = "CRASHED!";
            this.elements.messageText.textContent = `Your Final Score: ${Math.floor(this.state.score)}`;
            this.elements.resumeBtn.style.display = 'none';
            this.elements.restartBtn.textContent = 'Play Again';
            this.elements.messageBox.style.display = 'block';
        }

        togglePause() {
            if (!this.state.gameRunning) return;
            this.state.isPaused = !this.state.isPaused;
            if (this.state.isPaused) {
                this.sounds.engine.volume.rampTo(-Infinity, 0.1);
                this.elements.messageTitle.textContent = "Paused";
                this.elements.messageText.textContent = "";
                this.elements.resumeBtn.style.display = 'inline-block';
                this.elements.restartBtn.textContent = 'Restart';
                this.elements.messageBox.style.display = 'block';
                cancelAnimationFrame(this.state.gameLoopId);
            } else {
                this.sounds.engine.volume.rampTo(-20, 0.1);
                this.elements.messageBox.style.display = 'none';
                this.gameLoop();
            }
        }
        
        // --- OBJECT SPAWNING ---
        spawnObstacle() {
            if (this.state.obstacles.length > 5) return;
            const roadStartX = (this.elements.canvas.width * (1-this.state.roadWidth))/2;
            const img = this.assets.obstacleImages[Math.floor(Math.random() * this.assets.obstacleImages.length)];
            const isTruck = img.src.includes('280');
            const width = isTruck ? 70 : 60;
            const height = isTruck ? 140 : 110;
            const x = Math.random() * (this.elements.canvas.width * this.state.roadWidth - width) + roadStartX;
            const speed = Math.random() * (this.state.physics.maxSpeed * 0.4) + (this.state.physics.maxSpeed * 0.3);
            this.state.obstacles.push({ x, y: -height, width, height, image: img, speed });
        }

        spawnScenery() {
             if (this.state.scenery.length > 20) return;
             const side = Math.random() < 0.5 ? 'left' : 'right';
             const roadEdge = (this.elements.canvas.width * (1 - this.state.roadWidth)) / 2;
             const x = side === 'left' ? Math.random() * (roadEdge - 40) : this.elements.canvas.width - roadEdge + Math.random() * (roadEdge-20);
             this.state.scenery.push({ x, y: -50, size: Math.random() * 30 + 20, color: `hsl(120, 100%, ${Math.random() * 15 + 15}%)` });
        }

        // --- CORE GAME LOOP ---
        update() {
            if (!this.state.gameRunning || this.state.isPaused) return;

            // Physics Update
            let { carSpeed, currentGear, isAccelerating, isBraking } = this.state;
            const { acceleration, braking, friction, maxSpeed, gearRatios } = this.state.physics;
            let maxGearSpeed = gearRatios[currentGear];

            if (currentGear > 0 && isAccelerating && carSpeed < maxGearSpeed) carSpeed += acceleration;
            else if (currentGear === -1 && isAccelerating && carSpeed > -maxGearSpeed) carSpeed -= acceleration;
            
            if (isBraking) {
                carSpeed += carSpeed > 0 ? -braking : braking;
                if (Math.abs(carSpeed) < braking) carSpeed = 0;
            }

            if (!isAccelerating) {
                if (Math.abs(carSpeed) < friction) carSpeed = 0;
                else if (carSpeed > 0) carSpeed -= friction;
                else if (carSpeed < 0) carSpeed += friction;
            }
            
            if (carSpeed > maxSpeed) carSpeed = maxSpeed;
            if (carSpeed < -gearRatios['-1']) carSpeed = -gearRatios['-1'];
            this.state.carSpeed = carSpeed;
            
            // Player horizontal movement
            this.state.player.x += this.state.player.dx;
            const roadStartX = (this.elements.canvas.width * (1 - this.state.roadWidth)) / 2;
            const roadEndX = this.elements.canvas.width - roadStartX;
            if (this.state.player.x < roadStartX) this.state.player.x = roadStartX;
            if (this.state.player.x + this.state.player.width > roadEndX) this.state.player.x = roadEndX - this.state.player.width;

            // Update world objects
            this.state.roadLines.forEach(l => {
                l.y += carSpeed;
                if (l.y > this.elements.canvas.height) l.y -= this.elements.canvas.height + 20;
                if (l.y < -20) l.y += this.elements.canvas.height + 20;
            });
            this.state.scenery.forEach((s, i) => {
                s.y += carSpeed * 0.7;
                if (s.y > this.elements.canvas.height + 50 || s.y < -50) this.state.scenery.splice(i, 1);
            });
            this.state.obstacles.forEach((o, i) => {
                o.y += carSpeed - o.speed;
                if (o.y > this.elements.canvas.height) this.state.obstacles.splice(i, 1);
                this.checkCollision(this.state.player, o);
            });
            this.updateTrain();

            this.state.rumbleCounter += Math.abs(carSpeed);
            this.state.score += Math.abs(carSpeed) / 10;
        }

        draw() {
            this.ctx.clearRect(0, 0, this.elements.canvas.width, this.elements.canvas.height);
            
            // Environment
            this.ctx.fillStyle = this.colors.grass;
            this.ctx.fillRect(0, 0, this.elements.canvas.width, this.elements.canvas.height);
            this.state.scenery.forEach(s => {
                 this.ctx.fillStyle = s.color; this.ctx.beginPath(); this.ctx.moveTo(s.x, s.y);
                 this.ctx.lineTo(s.x - s.size/2, s.y + s.size); this.ctx.lineTo(s.x + s.size/2, s.y + s.size); this.ctx.fill();
            });

            // Road
            const roadStartX = (this.elements.canvas.width * (1 - this.state.roadWidth)) / 2;
            const roadDrawWidth = this.elements.canvas.width * this.state.roadWidth;
            this.ctx.fillStyle = this.colors.road;
            this.ctx.fillRect(roadStartX, 0, roadDrawWidth, this.elements.canvas.height);
            
            // Rumble strips
            const rumbleWidth = 10;
            for(let i=0; i < this.elements.canvas.height / 20; i++){
                this.ctx.fillStyle = (Math.floor(this.state.rumbleCounter / 10) + i) % 2 === 0 ? this.colors.rumble1 : this.colors.rumble2;
                this.ctx.fillRect(roadStartX - rumbleWidth, i * 20, rumbleWidth, 10);
                this.ctx.fillRect(roadStartX + roadDrawWidth, i * 20, rumbleWidth, 10);
            }
            
            // Road Lines
            this.state.roadLines.forEach(l => {
                const p = l.y / this.elements.canvas.height;
                const w = 5 * (1 + p * 2); const x = this.elements.canvas.width/2 - w/2;
                this.ctx.fillStyle = this.colors.line; this.ctx.fillRect(x, l.y, w, 20);
            });

            this.drawTrain();

            // Sort and draw entities
            const entities = [...this.state.obstacles, this.state.player].sort((a,b) => a.y - b.y);
            entities.forEach(e => {
                const img = e === this.state.player ? this.assets.playerImage : e.image;
                if (e === this.state.player) {
                    const originalSVG = decodeURIComponent(img.src.split(',')[1]);
                    const newSVG = originalSVG.replace(/class="brakelight" visibility="[^"]*"/g, `class="brakelight" visibility="${this.state.isBraking ? 'visible' : 'hidden'}"`);
                    const newImg = new Image();
                    newImg.src = "data:image/svg+xml," + encodeURIComponent(newSVG);
                    this.ctx.drawImage(newImg, e.x, e.y, e.width, e.height);
                } else {
                   this.ctx.drawImage(img, e.x, e.y, e.width, e.height);
                }
            });
            
            this.updateUI();
        }

        gameLoop() {
            this.update();
            this.draw();
            this.state.gameLoopId = requestAnimationFrame(() => this.gameLoop());
        }

        // --- HELPERS ---
        checkCollision(player, obs) {
            const margin = 5;
            if (player.x < obs.x + obs.width - margin && player.x + player.width > obs.x + margin &&
                player.y < obs.y + obs.height - margin && player.y + player.height > obs.y + margin) {
                this.gameOver();
            }
        }
        
        updateTrain() {
            let { train } = this.state;
            train.timer -= 16;
            if (train.timer < 0 && !train.active) {
                train.active = true;
                train.y = -50;
            }
            if(train.active){
                train.y += 20; // Train speed
                train.lightsOn = Math.floor(Date.now() / 300) % 2 === 0;
                if (train.y > this.elements.canvas.height + 50) {
                    train.active = false;
                    train.timer = 10000 + Math.random() * 10000;
                }
                const crossingY = this.elements.canvas.height * 0.3;
                if(this.state.player.y < crossingY + 20 && this.state.player.y + this.state.player.height > crossingY && train.y > crossingY-50 && train.y < crossingY+50){
                    this.gameOver();
                }
            }
        }

        drawTrain() {
            let { train } = this.state;
            const crossingY = this.elements.canvas.height * 0.3;
            // Tracks
            this.ctx.fillStyle = '#614126';
            this.ctx.fillRect(0, crossingY, this.elements.canvas.width, 20);
            for(let i=0; i<this.elements.canvas.width/20; i++){
                this.ctx.fillStyle = '#8B4513';
                this.ctx.fillRect(i*20, crossingY+2, 10, 16);
            }
            // Train
            if(train.active) {
                this.ctx.fillStyle = '#444';
                this.ctx.fillRect(-this.elements.canvas.width + train.y * 3, crossingY-15, 50, 50);
                this.ctx.fillStyle = '#666';
                this.ctx.fillRect(-this.elements.canvas.width + train.y * 3 + 60, crossingY-10, 80, 40);
            }
             // Lights
            if(train.active && train.lightsOn) {
                this.ctx.fillStyle = this.colors.rumble2;
                this.ctx.beginPath(); this.ctx.arc(this.elements.canvas.width - 20, crossingY - 20, 10, 0, Math.PI*2); this.ctx.fill();
            }
        }

        updateUI() {
            this.elements.scoreEl.textContent = `Score: ${Math.floor(this.state.score)}`;
            this.elements.speedometerEl.textContent = `${Math.floor(Math.abs(this.state.carSpeed) * 15)} KPH`;
            let gearText = this.state.currentGear === 0 ? 'N' : (this.state.currentGear === -1 ? 'R' : this.state.currentGear);
            this.elements.gearDisplayEl.textContent = `GEAR: ${gearText}`;
            this.sounds.engine.frequency.value = 60 + (Math.abs(this.state.carSpeed) * 10);
            this.sounds.engine.volume.value = -25 + (Math.abs(this.state.carSpeed));
        }

        resizeCanvas() {
            this.elements.canvas.width = this.elements.container.clientWidth;
            this.elements.canvas.height = this.elements.container.clientHeight;
            if (!this.state.gameRunning) this.resetState();
        }

        // --- CONTROLS ---
        handleKeyDown(e) {
            const s = this.state;
            if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') s.player.dx = -s.player.speed;
            if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') s.player.dx = s.player.speed;
            if (e.key === 'ArrowUp' || e.key.toLowerCase() === 'w') { s.isAccelerating = true; this.elements.accelerator.classList.add('pressed'); }
            if (e.key === 'ArrowDown' || e.key.toLowerCase() === 's') { s.isBraking = true; this.elements.brake.classList.add('pressed'); }
        }
        handleKeyUp(e) {
            const s = this.state;
            if ((e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') && s.player.dx < 0) s.player.dx = 0;
            if ((e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') && s.player.dx > 0) s.player.dx = 0;
            if (e.key === 'ArrowUp' || e.key.toLowerCase() === 'w') { s.isAccelerating = false; this.elements.accelerator.classList.remove('pressed'); }
            if (e.key === 'ArrowDown' || e.key.toLowerCase() === 's') { s.isBraking = false; this.elements.brake.classList.remove('pressed'); }
        }
        handleGearUp() { if (this.state.currentGear < 5) this.state.currentGear++; }
        handleGearDown() { if (this.state.currentGear > -1) this.state.currentGear--; }
    }

    window.addEventListener('load', () => {
        const game = new Game();
        setInterval(() => game.state.gameRunning && !game.state.isPaused && game.spawnObstacle(), 1500);
        setInterval(() => game.state.gameRunning && !game.state.isPaused && game.spawnScenery(), 400);
    });
    </script>
</body>
</html>

